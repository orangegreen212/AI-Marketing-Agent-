import streamlit as st
from mistralai.client import MistralClient
from mistralai.models.chat_completion import ChatMessage

# –ü—Ä–∏–ø—É—Å–∫–∞—î–º–æ, —â–æ PROMPT_TEMPLATE –≤–∏–∑–Ω–∞—á–µ–Ω–∏–π –¥–µ—Å—å —Ç—É—Ç, —è–∫ —ñ —Ä–∞–Ω—ñ—à–µ
PROMPT_TEMPLATE = """
–¢–∏ ‚Äî –¥–æ—Å–≤—ñ–¥—á–µ–Ω–∏–π –º–∞—Ä–∫–µ—Ç–æ–ª–æ–≥ —Ç–∞ —Ç–∞–ª–∞–Ω–æ–≤–∏—Ç–∏–π –∫–æ–ø—ñ—Ä–∞–π—Ç–µ—Ä –Ω–∞—à–æ–≥–æ —ñ–Ω—Ç–µ—Ä–Ω–µ—Ç-–º–∞–≥–∞–∑–∏–Ω—É –∫–æ—Å–º–µ—Ç–∏–∫–∏ —Ç–∞ –ø–∞—Ä—Ñ—É–º–µ—Ä—ñ—ó. –¢–≤–æ—î –∑–∞–≤–¥–∞–Ω–Ω—è ‚Äî –∑–≥–µ–Ω–µ—Ä—É–≤–∞—Ç–∏ –ø–µ—Ä—Å–æ–Ω–∞–ª—ñ–∑–æ–≤–∞–Ω–∏–π, —Ç–µ–ø–ª–∏–π —Ç–∞ –¥—Ä—É–∂–Ω—ñ–π email –¥–ª—è –Ω–∞—à–æ–≥–æ –∫–ª—ñ—î–Ω—Ç–∞. –£–Ω–∏–∫–∞–π –∫–ª—ñ—à–µ —Ç–∞ –∑–∞–Ω–∞–¥—Ç–æ "—Ä–æ–±–æ—Ç–∏–∑–æ–≤–∞–Ω–∏—Ö" —Ñ—Ä–∞–∑.

**–í—Ö—ñ–¥–Ω—ñ –¥–∞–Ω—ñ –ø—Ä–æ –∫–ª—ñ—î–Ω—Ç–∞:**
*   **–°–µ–≥–º–µ–Ω—Ç:** {customer_segment}
*   **–ö–∞—Ç–µ–≥–æ—Ä—ñ—ó, —â–æ –π–æ–≥–æ —Ü—ñ–∫–∞–≤–ª—è—Ç—å:** {interested_categories}
*   **–°–µ—Ä–µ–¥–Ω—ñ–π —á–µ–∫:** {average_check}
*   **–Ü–º'—è –∫–ª—ñ—î–Ω—Ç–∞ (—è–∫—â–æ —î):** {customer_name}

**–ó–∞–≤–¥–∞–Ω–Ω—è:**
–ó–≥–µ–Ω–µ—Ä—É–π —Ç–µ–∫—Å—Ç –ª–∏—Å—Ç–∞ –∑ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—î—é –Ω–æ–≤–æ–≥–æ —Ç–æ–≤–∞—Ä—É —Ç–∞ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ—é –∑–Ω–∏–∂–∫–æ—é.
*   **–¢–æ–≤–∞—Ä –¥–ª—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—ó:** {new_product_name}
*   **–ö–∞—Ç–µ–≥–æ—Ä—ñ—è —Ç–æ–≤–∞—Ä—É:** {new_product_category}
*   **–†–æ–∑–º—ñ—Ä –∑–Ω–∏–∂–∫–∏:** {discount_amount}
*   **–ü—Ä–æ–º–æ–∫–æ–¥:** {promo_code}

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ª–∏—Å—Ç–∞, —è–∫–æ—ó –ø–æ—Ç—Ä—ñ–±–Ω–æ –¥–æ—Ç—Ä–∏–º—É–≤–∞—Ç–∏—Å—è:**

1.  **–¢–µ–º–∞ –ª–∏—Å—Ç–∞ (Subject):** –ú–∞—î –±—É—Ç–∏ —ñ–Ω—Ç—Ä–∏–≥—É—é—á–æ—é —Ç–∞ –ø–µ—Ä—Å–æ–Ω–∞–ª—ñ–∑–æ–≤–∞–Ω–æ—é.
2.  **–¢—ñ–ª–æ –ª–∏—Å—Ç–∞ (Body):**
    *   **–ó–≤–µ—Ä–Ω–µ–Ω–Ω—è:** –ü—Ä–∏–≤—ñ—Ç–∞–π –∫–ª—ñ—î–Ω—Ç–∞ –Ω–∞ —ñ–º'—è –∞–±–æ –¥—Ä—É–∂–Ω—å–æ.
    *   **–í–∏–∑–Ω–∞–Ω–Ω—è —Å—Ç–∞—Ç—É—Å—É:** –ü–æ–¥—è–∫—É–π –∑–∞ –ª–æ—è–ª—å–Ω—ñ—Å—Ç—å –∞–±–æ –ø—Ä–∏–≤—ñ—Ç–∞–π –∑ –ø–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è–º, –±–∞–∑—É—é—á–∏—Å—å –Ω–∞ —Å–µ–≥–º–µ–Ω—Ç—ñ.
    *   **–ü–ª–∞–≤–Ω–∏–π –ø–µ—Ä–µ—Ö—ñ–¥:** –ó–≤'—è–∂–∏ –Ω–æ–≤–∏–Ω–∫—É –∑ —ñ–Ω—Ç–µ—Ä–µ—Å–∞–º–∏ –∫–ª—ñ—î–Ω—Ç–∞.
    *   **–û–ø–∏—Å —Ç–æ–≤–∞—Ä—É:** –ö–æ—Ä–æ—Ç–∫–æ —ñ –ø—Ä–∏–≤–∞–±–ª–∏–≤–æ.
    *   **–ó–∞–∫–ª–∏–∫ –¥–æ –¥—ñ—ó (Call to Action):** –ß—ñ—Ç–∫–∞ –∫–Ω–æ–ø–∫–∞ –∞–±–æ –ø–æ—Å–∏–ª–∞–Ω–Ω—è.
    *   **–ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∞ –ø—Ä–æ–ø–æ–∑–∏—Ü—ñ—è:** –Ø—Å–∫—Ä–∞–≤–æ –≤–∏–¥—ñ–ª–∏ –∑–Ω–∏–∂–∫—É —Ç–∞ –ø—Ä–æ–º–æ–∫–æ–¥.
    *   **–ó–∞–≤–µ—Ä—à–µ–Ω–Ω—è:** –î—Ä—É–∂–Ω—î —ñ —Ç–µ–ø–ª–µ.
"""


# --- –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –∫–ª—ñ—î–Ω—Ç–∞ ---
# –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ st.secrets –¥–ª—è –±–µ–∑–ø–µ—á–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø—É –¥–æ –∫–ª—é—á–∞
try:
    client = MistralClient(api_key=st.secrets["MISTRAL_API_KEY"])
    API_KEY_CONFIGURED = True
except (KeyError, FileNotFoundError):
    API_KEY_CONFIGURED = False


def generate_email_mistral(customer_data, model_name="mistral-small-latest"):
    """–í–∏–∫–ª–∏–∫–∞—î Mistral API –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü—ñ—ó –ª–∏—Å—Ç–∞."""
    filled_prompt = PROMPT_TEMPLATE.format(**customer_data)
    
    try:
        messages = [
            ChatMessage(role="user", content=filled_prompt)
        ]
        
        chat_response = client.chat(
            model=model_name,
            messages=messages,
            temperature=0.7
        )
        
        return chat_response.choices[0].message.content
    except Exception as e:
        return f"–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –≤–∏–∫–ª–∏–∫—É API Mistral: {e}"

# --- –Ü–ù–¢–ï–†–§–ï–ô–° STREAMLIT ---
st.title("ü§ñ –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –ø–µ—Ä—Å–æ–Ω–∞–ª—ñ–∑–æ–≤–∞–Ω–∏—Ö Email")

if API_KEY_CONFIGURED:
    with st.form("customer_form"):
        st.header("–î–∞–Ω—ñ –ø—Ä–æ –∫–ª—ñ—î–Ω—Ç–∞ —Ç–∞ –ø—Ä–æ–ø–æ–∑–∏—Ü—ñ—é")
        
        customer_segment = st.selectbox("–°–µ–≥–º–µ–Ω—Ç –∫–ª—ñ—î–Ω—Ç–∞", ["VIP / –ß–µ–º–ø—ñ–æ–Ω–∏", "–õ–æ—è–ª—å–Ω—ñ / –†–µ–≥—É–ª—è—Ä–Ω—ñ –ø–æ–∫—É–ø—Ü—ñ", "–û–ø—Ç–æ–≤—ñ –ø–æ–∫—É–ø—Ü—ñ / –ü—Ä–æ—Ñ–µ—Å—ñ–æ–Ω–∞–ª–∏", "–ù–æ–≤–∞—á–∫–∏"])
        interested_categories = st.text_input("–ö–∞—Ç–µ–≥–æ—Ä—ñ—ó, —â–æ —Ü—ñ–∫–∞–≤–ª—è—Ç—å", "–ø–∞—Ä—Ñ—É–º–∏, nail art")
        new_product_name = st.text_input("–ù–∞–∑–≤–∞ –Ω–æ–≤–æ–≥–æ —Ç–æ–≤–∞—Ä—É", "–õ–∞–∫ –¥–ª—è –Ω—ñ–≥—Ç—ñ–≤ 'Galaxy Dust'")
        discount_amount = st.text_input("–†–æ–∑–º—ñ—Ä –∑–Ω–∏–∂–∫–∏", "20%")
        promo_code = st.text_input("–ü—Ä–æ–º–æ–∫–æ–¥", "GALAXY20")
        
        submitted = st.form_submit_button("–ó–≥–µ–Ω–µ—Ä—É–≤–∞—Ç–∏ –ª–∏—Å—Ç")

    if submitted:
        customer_data = {
            "customer_segment": customer_segment,
            "interested_categories": interested_categories,
            "average_check": "45.00$",
            "customer_name": "—à–∞–Ω–æ–≤–Ω–∏–π –∫–ª—ñ—î–Ω—Ç–µ",
            "new_product_name": new_product_name,
            "new_product_category": "nail art",
            "discount_amount": discount_amount,
            "promo_code": promo_code,
        }
        
        # –í–ò–ü–†–ê–í–õ–ï–ù–û: –¢–µ–∫—Å—Ç –¥–ª—è –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω–æ—Å—Ç—ñ Mistral
        with st.spinner("–ú–∞–≥—ñ—è Mistral –ø—Ä–∞—Ü—é—î... ‚ú®"):
            # –í–ò–ü–†–ê–í–õ–ï–ù–û: –ù–∞–∑–≤–∞ —Ñ—É–Ω–∫—Ü—ñ—ó —Ç–µ–ø–µ—Ä –ø—Ä–∞–≤–∏–ª—å–Ω–∞
            email_text = generate_email_mistral(customer_data)
        
        st.subheader("–ó–≥–µ–Ω–µ—Ä–æ–≤–∞–Ω–∏–π –ª–∏—Å—Ç:")
        st.markdown(email_text)
else:
    st.error("API-–∫–ª—é—á Mistral –Ω–µ –Ω–∞–ª–∞—à—Ç–æ–≤–∞–Ω–æ! –ë—É–¥—å –ª–∞—Å–∫–∞, –¥–æ–¥–∞–π—Ç–µ MISTRAL_API_KEY –¥–æ –≤–∞—à–∏—Ö —Å–µ–∫—Ä–µ—Ç—ñ–≤ Streamlit.")
