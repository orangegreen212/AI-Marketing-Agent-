
import os

import streamlit as st
import mistralai

# –ü—Ä–∞–≤–∏–ª—å–Ω–∏–π —Å–ø–æ—Å—ñ–± –¥–ª—è Streamlit Cloud
mistralai.api_key = st.secrets["MISTRAL_API_KEY"]

PROMPT_TEMPLATE = """
–¢–∏ ‚Äî –¥–æ—Å–≤—ñ–¥—á–µ–Ω–∏–π –º–∞—Ä–∫–µ—Ç–æ–ª–æ–≥ —Ç–∞ —Ç–∞–ª–∞–Ω–æ–≤–∏—Ç–∏–π –∫–æ–ø—ñ—Ä–∞–π—Ç–µ—Ä –Ω–∞—à–æ–≥–æ —ñ–Ω—Ç–µ—Ä–Ω–µ—Ç-–º–∞–≥–∞–∑–∏–Ω—É –∫–æ—Å–º–µ—Ç–∏–∫–∏ —Ç–∞ –ø–∞—Ä—Ñ—É–º–µ—Ä—ñ—ó. –¢–≤–æ—î –∑–∞–≤–¥–∞–Ω–Ω—è ‚Äî –∑–≥–µ–Ω–µ—Ä—É–≤–∞—Ç–∏ –ø–µ—Ä—Å–æ–Ω–∞–ª—ñ–∑–æ–≤–∞–Ω–∏–π, —Ç–µ–ø–ª–∏–π —Ç–∞ –¥—Ä—É–∂–Ω—ñ–π email –¥–ª—è –Ω–∞—à–æ–≥–æ –∫–ª—ñ—î–Ω—Ç–∞. –£–Ω–∏–∫–∞–π –∫–ª—ñ—à–µ —Ç–∞ –∑–∞–Ω–∞–¥—Ç–æ "—Ä–æ–±–æ—Ç–∏–∑–æ–≤–∞–Ω–∏—Ö" —Ñ—Ä–∞–∑.

**–í—Ö—ñ–¥–Ω—ñ –¥–∞–Ω—ñ –ø—Ä–æ –∫–ª—ñ—î–Ω—Ç–∞:**
*   **–°–µ–≥–º–µ–Ω—Ç:** {customer_segment}
*   **–ö–∞—Ç–µ–≥–æ—Ä—ñ—ó, —â–æ –π–æ–≥–æ —Ü—ñ–∫–∞–≤–ª—è—Ç—å:** {interested_categories}
*   **–°–µ—Ä–µ–¥–Ω—ñ–π —á–µ–∫:** {average_check}
*   **–Ü–º'—è –∫–ª—ñ—î–Ω—Ç–∞ (—è–∫—â–æ —î):** {customer_name}

**–ó–∞–≤–¥–∞–Ω–Ω—è:**
–ó–≥–µ–Ω–µ—Ä—É–π —Ç–µ–∫—Å—Ç –ª–∏—Å—Ç–∞ –∑ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—î—é –Ω–æ–≤–æ–≥–æ —Ç–æ–≤–∞—Ä—É —Ç–∞ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ—é –∑–Ω–∏–∂–∫–æ—é.
*   **–¢–æ–≤–∞—Ä –¥–ª—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—ó:** {new_product_name}
*   **–ö–∞—Ç–µ–≥–æ—Ä—ñ—è —Ç–æ–≤–∞—Ä—É:** {new_product_category}
*   **–†–æ–∑–º—ñ—Ä –∑–Ω–∏–∂–∫–∏:** {discount_amount}
*   **–ü—Ä–æ–º–æ–∫–æ–¥:** {promo_code}

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ª–∏—Å—Ç–∞, —è–∫–æ—ó –ø–æ—Ç—Ä—ñ–±–Ω–æ –¥–æ—Ç—Ä–∏–º—É–≤–∞—Ç–∏—Å—è:**

1.  **–¢–µ–º–∞ –ª–∏—Å—Ç–∞ (Subject):** –ú–∞—î –±—É—Ç–∏ —ñ–Ω—Ç—Ä–∏–≥—É—é—á–æ—é —Ç–∞ –ø–µ—Ä—Å–æ–Ω–∞–ª—ñ–∑–æ–≤–∞–Ω–æ—é. –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é –ø—Ä–æ —É–ª—é–±–ª–µ–Ω—ñ –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó –∫–ª—ñ—î–Ω—Ç–∞.

2.  **–¢—ñ–ª–æ –ª–∏—Å—Ç–∞ (Body):**
    *   **–ó–≤–µ—Ä–Ω–µ–Ω–Ω—è:** –ü—Ä–∏–≤—ñ—Ç–∞–π –∫–ª—ñ—î–Ω—Ç–∞ –Ω–∞ —ñ–º'—è. –Ø–∫—â–æ —ñ–º–µ–Ω—ñ –Ω–µ–º–∞—î, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π –¥—Ä—É–∂–Ω—î "–í—ñ—Ç–∞—î–º–æ!".
    *   **–í–∏–∑–Ω–∞–Ω–Ω—è —Å—Ç–∞—Ç—É—Å—É:** –ë–∞–∑—É—é—á–∏—Å—å –Ω–∞ —Å–µ–≥–º–µ–Ω—Ç—ñ –∫–ª—ñ—î–Ω—Ç–∞, –ø–æ—á–Ω–∏ –ª–∏—Å—Ç.
        *   –î–ª—è "VIP / –ß–µ–º–ø—ñ–æ–Ω–∏" –∞–±–æ "–û–ø—Ç–æ–≤—ñ –ø–æ–∫—É–ø—Ü—ñ": –ü–æ–¥—è–∫—É–π –∑–∞ –ª–æ—è–ª—å–Ω—ñ—Å—Ç—å —Ç–∞ –¥–æ–≤—ñ—Ä—É.
        *   –î–ª—è "–õ–æ—è–ª—å–Ω—ñ / –†–µ–≥—É–ª—è—Ä–Ω—ñ –ø–æ–∫—É–ø—Ü—ñ": –°–∫–∞–∂–∏, —â–æ —Ç–∏ —Ü—ñ–Ω—É—î—à –π–æ–≥–æ —è–∫ –ø–æ—Å—Ç—ñ–π–Ω–æ–≥–æ –∫–ª—ñ—î–Ω—Ç–∞.
        *   –î–ª—è "–ù–æ–≤–∞—á–∫–∏" –∞–±–æ "–ó–∞—Ç–∏—Ö–∞—é—á—ñ": –ó–≤–µ—Ä–Ω–∏—Å—å –∑ —Ç–µ–ø–ª–æ—Ç–æ—é, —Å–∫–∞–∂–∏, —â–æ —Ç–∏ —Ä–∞–¥–∏–π –π–æ–≥–æ –±–∞—á–∏—Ç–∏ –∑–Ω–æ–≤—É.
    *   **–ü–ª–∞–≤–Ω–∏–π –ø–µ—Ä–µ—Ö—ñ–¥ –¥–æ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—ó:** –ó–≤'—è–∂–∏ –Ω–æ–≤–∏–π —Ç–æ–≤–∞—Ä –∑ —É–ª—é–±–ª–µ–Ω–∏–º–∏ –∫–∞—Ç–µ–≥–æ—Ä—ñ—è–º–∏ –∫–ª—ñ—î–Ω—Ç–∞. –ù–∞–ø—Ä–∏–∫–ª–∞–¥: "–ú–∏ –∑–Ω–∞—î–º–æ, —è–∫ –≤–∏ –ª—é–±–∏—Ç–µ {interested_categories}, —Ç–æ–º—É –≤–∏—Ä—ñ—à–∏–ª–∏, —â–æ –≤–∞—Å —Ç–æ—á–Ω–æ –∑–∞—Ü—ñ–∫–∞–≤–∏—Ç—å –Ω–∞—à–∞ –Ω–æ–≤–∏–Ω–∫–∞..."
    *   **–û–ø–∏—Å —Ç–æ–≤–∞—Ä—É:** –ö–æ—Ä–æ—Ç–∫–æ —ñ –ø—Ä–∏–≤–∞–±–ª–∏–≤–æ –æ–ø–∏—à–∏ {new_product_name}, –ø—ñ–¥–∫—Ä–µ—Å–ª—é—é—á–∏ –π–æ–≥–æ –ø–µ—Ä–µ–≤–∞–≥–∏.
    *   **–ó–∞–∫–ª–∏–∫ –¥–æ –¥—ñ—ó (Call to Action):** –ß—ñ—Ç–∫–∞ –∫–Ω–æ–ø–∫–∞ –∞–±–æ –ø–æ—Å–∏–ª–∞–Ω–Ω—è, –Ω–∞–ø—Ä–∏–∫–ª–∞–¥: "–î—ñ–∑–Ω–∞—Ç–∏—Å—å –±—ñ–ª—å—à–µ", "–ü–æ–¥–∏–≤–∏—Ç–∏—Å—å –Ω–æ–≤–∏–Ω–∫—É".
    *   **–ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∞ –ø—Ä–æ–ø–æ–∑–∏—Ü—ñ—è:** –Ø—Å–∫—Ä–∞–≤–æ –≤–∏–¥—ñ–ª–∏ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é –ø—Ä–æ –∑–Ω–∏–∂–∫—É {discount_amount} –∑–∞ –ø—Ä–æ–º–æ–∫–æ–¥–æ–º {promo_code}. –í–∫–∞–∂–∏, —â–æ —Ü—è –ø—Ä–æ–ø–æ–∑–∏—Ü—ñ—è ‚Äî —Å–∞–º–µ –¥–ª—è –Ω—å–æ–≥–æ.
    *   **–ó–∞–≤–µ—Ä—à–µ–Ω–Ω—è:** –î—Ä—É–∂–Ω—î —ñ —Ç–µ–ø–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è, –Ω–∞–ø—Ä–∏–∫–ª–∞–¥: "–ó –Ω–∞–π–∫—Ä–∞—â–∏–º–∏ –ø–æ–±–∞–∂–∞–Ω–Ω—è–º–∏, –∫–æ–º–∞–Ω–¥–∞ [–ù–∞–∑–≤–∞ –º–∞–≥–∞–∑–∏–Ω—É]".
"""

def generate_email_chatgpt(customer_data):
    """–í–∏–∫–ª–∏–∫–∞—î ChatGPT API –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü—ñ—ó –ª–∏—Å—Ç–∞."""
    filled_prompt = PROMPT_TEMPLATE.format(**customer_data)
    
    try:
        response = openai.chat.completions.create(
            model="gpt-3.5-turbo",
            messages=[
                {"role": "system", "content": "–¢–∏ ‚Äî –∫–æ–ø—ñ—Ä–∞–π—Ç–µ—Ä-–º–∞—Ä–∫–µ—Ç–æ–ª–æ–≥ –¥–ª—è –º–∞–≥–∞–∑–∏–Ω—É –∫–æ—Å–º–µ—Ç–∏–∫–∏."},
                {"role": "user", "content": filled_prompt}
            ],
            temperature=0.7,
            max_tokens=500
        )
        return response.choices[0].message.content
    except Exception as e:
        return f"–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –≤–∏–∫–ª–∏–∫—É API: {e}"

# --- –Ü–ù–¢–ï–†–§–ï–ô–° STREAMLIT ---
st.title("ü§ñ –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –ø–µ—Ä—Å–æ–Ω–∞–ª—ñ–∑–æ–≤–∞–Ω–∏—Ö Email")

with st.form("customer_form"):
    st.header("–î–∞–Ω—ñ –ø—Ä–æ –∫–ª—ñ—î–Ω—Ç–∞ —Ç–∞ –ø—Ä–æ–ø–æ–∑–∏—Ü—ñ—é")
    
    customer_segment = st.selectbox("–°–µ–≥–º–µ–Ω—Ç –∫–ª—ñ—î–Ω—Ç–∞", ["VIP / –ß–µ–º–ø—ñ–æ–Ω–∏", "–õ–æ—è–ª—å–Ω—ñ / –†–µ–≥—É–ª—è—Ä–Ω—ñ –ø–æ–∫—É–ø—Ü—ñ", "–û–ø—Ç–æ–≤—ñ –ø–æ–∫—É–ø—Ü—ñ / –ü—Ä–æ—Ñ–µ—Å—ñ–æ–Ω–∞–ª–∏", "–ù–æ–≤–∞—á–∫–∏"])
    interested_categories = st.text_input("–ö–∞—Ç–µ–≥–æ—Ä—ñ—ó, —â–æ —Ü—ñ–∫–∞–≤–ª—è—Ç—å", "–ø–∞—Ä—Ñ—É–º–∏, nail art")
    new_product_name = st.text_input("–ù–∞–∑–≤–∞ –Ω–æ–≤–æ–≥–æ —Ç–æ–≤–∞—Ä—É", "–õ–∞–∫ –¥–ª—è –Ω—ñ–≥—Ç—ñ–≤ 'Galaxy Dust'")
    discount_amount = st.text_input("–†–æ–∑–º—ñ—Ä –∑–Ω–∏–∂–∫–∏", "20%")
    promo_code = st.text_input("–ü—Ä–æ–º–æ–∫–æ–¥", "GALAXY20")
    
    submitted = st.form_submit_button("–ó–≥–µ–Ω–µ—Ä—É–≤–∞—Ç–∏ –ª–∏—Å—Ç")

if submitted:
    customer_data = {
        "customer_segment": customer_segment,
        "interested_categories": interested_categories,
        "average_check": "45.00$",
        "customer_name": "—à–∞–Ω–æ–≤–Ω–∏–π –∫–ª—ñ—î–Ω—Ç–µ",
        "new_product_name": new_product_name,
        "new_product_category": "nail art",
        "discount_amount": discount_amount,
        "promo_code": promo_code,
    }
    
    with st.spinner("–ú–∞–≥—ñ—è GPT –ø—Ä–∞—Ü—é—î... ‚ú®"):
        email_text = generate_email_chatgpt(customer_data)
    
    st.subheader("–ó–≥–µ–Ω–µ—Ä–æ–≤–∞–Ω–∏–π –ª–∏—Å—Ç:")
    st.markdown(email_text)

